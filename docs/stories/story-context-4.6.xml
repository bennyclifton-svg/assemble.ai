<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>6</storyId>
    <title>AI Price Extraction from Submissions</title>
    <status>Draft</status>
    <generatedAt>2025-11-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/4-6-ai-price-extraction-from-submissions.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>AI to extract pricing from tender submissions</iWant>
    <soThat>I don't have to manually enter all prices</soThat>
    <tasks>
      <task>Add AI Generate icon to firm columns</task>
      <task>Implement AI extraction service with OpenAI GPT-4 Vision API</task>
      <task>Load latest submission PDF from S3/Documents folder</task>
      <task>Extract text and use vision model for scanned PDFs</task>
      <task>Parse pricing data matching fee structure line items</task>
      <task>Design system prompt for construction tender pricing extraction</task>
      <task>Highlight AI-populated cells with background color</task>
      <task>Enable immediate inline editing of AI-populated values</task>
      <task>Handle multiple submission versions</task>
      <task>Create extractPricesFromSubmission server action</task>
      <task>Test with various PDF formats and extraction accuracy</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">AI generate fee table from latest Submission icon (accent color) displayed next to each firm column in Tender Evaluation tables</criterion>
    <criterion id="2">AI reads tender submission PDFs from Documents folder (Documents/[Consultant]/[Firm] Submission XX.PDF)</criterion>
    <criterion id="3">AI extracts pricing data matching the fee structure line items and populates evaluation tables</criterion>
    <criterion id="4">Highlights AI-populated cells with distinct visual indicator (e.g., light blue background)</criterion>
    <criterion id="5">Manual override enabled for all AI-populated values with inline editing</criterion>
    <criterion id="6">Handles multiple submission versions (Submission 1, Submission 2, etc.) - always uses latest by default</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Tender Evaluation AI Features (FR012_TE4, FR012_TE8)</section>
        <snippet>AI generate fee table from latest Submission icon that auto-populates fees by reviewing firm's tender submission</snippet>
      </doc>
      <doc>
        <path>docs/stories/4-5-tender-evaluation-price-setup.md</path>
        <title>Tender Evaluation Price Setup</title>
        <section>Handsontable Implementation</section>
        <snippet>Defines Handsontable-based PriceEvaluationTable component that this story must integrate with</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-3-ai-document-processing-text-extraction.md</path>
        <title>AI Document Processing</title>
        <section>Document Processing Pattern</section>
        <snippet>Establishes patterns for AI document processing with OpenAI Vision API and PDF extraction</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>AI Services</section>
        <snippet>Defines AI service architecture patterns and integration approaches</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>assemble-app/src/components/tender/PriceEvaluationTable.tsx</path>
        <kind>component</kind>
        <symbol>PriceEvaluationTable</symbol>
        <reason>Handsontable component to be enhanced with AI generate icons and populated cells</reason>
      </artifact>
      <artifact>
        <path>assemble-app/src/server/services/priceExtractor.ts</path>
        <kind>service</kind>
        <symbol>priceExtractor</symbol>
        <reason>New service to be created for AI-powered price extraction from PDFs</reason>
      </artifact>
      <artifact>
        <path>assemble-app/src/app/actions/tender.ts</path>
        <kind>server-actions</kind>
        <symbol>extractPricesFromSubmission</symbol>
        <reason>Server action to be added for triggering AI extraction</reason>
      </artifact>
      <artifact>
        <path>assemble-app/src/lib/ai/openai.ts</path>
        <kind>utils</kind>
        <reason>Existing OpenAI integration to be used for GPT-4 Vision API calls</reason>
      </artifact>
      <artifact>
        <path>assemble-app/src/server/services/documentProcessor.ts</path>
        <kind>service</kind>
        <reason>Reference implementation for PDF processing and S3 document retrieval</reason>
      </artifact>
      <artifact>
        <path>assemble-app/src/lib/ai/prompts.ts</path>
        <kind>utils</kind>
        <reason>Central location for AI prompts, needs tender pricing extraction prompt</reason>
      </artifact>
      <artifact>
        <path>assemble-app/prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>EvaluationLineItem</symbol>
        <reason>Model to extend with AI extraction metadata fields</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="handsontable" version="^13.1.0" reason="Required by Story 4-5, this story integrates with Handsontable tables" />
        <package name="@handsontable/react" version="^13.1.0" reason="React wrapper for Handsontable integration" />
        <package name="openai" version="^6.7.0" reason="Already installed, OpenAI API for GPT-4 Vision" />
        <package name="pdf-parse" version="^2.4.5" reason="Already installed, PDF text extraction" />
        <package name="@aws-sdk/client-s3" version="^3.917.0" reason="Already installed, S3 document retrieval" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must integrate with Handsontable data structure and rendering from Story 4-5</constraint>
    <constraint>Use Handsontable's setDataAtCell() API to populate extracted prices</constraint>
    <constraint>Use custom cell renderer for AI-populated cell highlighting</constraint>
    <constraint>Leverage afterChange callback to clear AI indicators on manual edits</constraint>
    <constraint>Follow existing AI document processing patterns from Story 2-3</constraint>
    <constraint>Store AI extraction metadata in cell meta, not visible data</constraint>
    <constraint>30-second timeout for AI processing with fallback message</constraint>
    <constraint>Validate all extracted values are valid decimals before populating</constraint>
    <constraint>Cache extracted pricing to avoid re-processing same submission</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>AI Cell Renderer</name>
      <kind>Handsontable Custom Renderer</kind>
      <signature>aiCellRenderer(instance, td, row, col, prop, value, cellProperties)</signature>
      <path>assemble-app/src/components/tender/PriceEvaluationTable.tsx</path>
    </interface>
    <interface>
      <name>Extract Prices Server Action</name>
      <kind>Server Action</kind>
      <signature>extractPricesFromSubmission(firmId, consultantId, submissionVersion?)</signature>
      <path>assemble-app/src/app/actions/tender.ts</path>
    </interface>
    <interface>
      <name>Price Extractor Service</name>
      <kind>Service Interface</kind>
      <signature>extractPricesFromPDF(pdfBuffer, feeStructure): Promise&lt;ExtractedPrices&gt;</signature>
      <path>assemble-app/src/server/services/priceExtractor.ts</path>
    </interface>
    <interface>
      <name>Handsontable Cell Metadata</name>
      <kind>Cell Metadata</kind>
      <signature>aiExtracted: boolean, confidence: number, extractedAt: Date</signature>
      <path>Handsontable cell meta interface</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Unit tests for priceExtractor service with mock PDF responses. Integration tests with sample tender PDFs. Test accuracy target: >90% correct extraction for structured pricing tables. Performance target: <10 seconds per 15MB PDF.</standards>
    <locations>assemble-app/src/server/services/__tests__/, assemble-app/src/app/actions/__tests__/, assemble-app/e2e/</locations>
    <ideas>
      <test ac="1">Test AI generate icon displays next to each firm column</test>
      <test ac="2">Test PDF retrieval from correct Documents folder path</test>
      <test ac="3">Test AI extraction accuracy against known pricing tables</test>
      <test ac="4">Test AI-populated cells show visual indicator</test>
      <test ac="5">Test manual override clears AI indicator</test>
      <test ac="6">Test latest submission version is used by default</test>
      <test ac="all">Test error handling for missing PDFs and AI failures</test>
      <test ac="all">Test extraction performance with large PDFs</test>
      <test ac="all">Test with scanned vs digital PDFs</test>
    </ideas>
  </tests>
</story-context>