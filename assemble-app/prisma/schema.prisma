// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Project {
  id        String     @id @default(cuid())
  name      String
  userId    String
  cards     Card[]
  documents Document[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?
}

model Card {
  id        String    @id @default(cuid())
  projectId String
  project   Project   @relation(fields: [projectId], references: [id])
  type      CardType
  sections  Section[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@index([projectId, type])
}

enum CardType {
  PLAN
  CONSULTANT
  CONTRACTOR
  PROCURE
  COST_PLANNING
  SCHEME_DESIGN
  DETAIL_DESIGN
  DOCUMENTS
  DELIVER
}

model Section {
  id        String    @id @default(cuid())
  cardId    String
  card      Card      @relation(fields: [cardId], references: [id], onDelete: Cascade)
  name      String
  order     Int
  items     Item[]
  tenderPackageSections TenderPackageSection[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@index([cardId, order])
}

model Item {
  id           String    @id @default(cuid())
  sectionId    String
  section      Section   @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  order        Int
  type         String    // 'text', 'number', 'date', 'toggle', 'status_icons'
  data         Json      // Flexible storage
  sourceCardId String?   // Cross-card reference for data flow
  sourceItemId String?   // Source item reference for traceability
  locked       Boolean   @default(false) // Immutability flag for tender packages
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  createdBy    String
  updatedBy    String
  deletedAt    DateTime?

  @@index([sectionId, order])
}

model Document {
  id            String    @id @default(cuid())
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id])

  // Hierarchy and storage
  path          String    // e.g., "Consultants/Architect"
  name          String    // Original filename
  displayName   String    // User-friendly name

  // S3 Storage
  s3Key         String    @unique
  s3Bucket      String
  url           String    // S3 URL
  size          Int       // File size in bytes
  mimeType      String
  checksum      String    // MD5 hash for integrity

  // AI Processing
  extractedText String?   @db.Text
  extractedData Json?     // Structured data from AI
  processingStatus String @default("pending") // pending, processing, completed, failed

  // Metadata
  tags          String[]
  version       Int       @default(1)
  metadata      Json?     // Additional metadata like auto-filing context

  // Audit fields
  createdAt     DateTime  @default(now())
  createdBy     String
  updatedAt     DateTime  @updatedAt
  updatedBy     String
  deletedAt     DateTime?

  // Relations
  tenderPackageDocuments TenderPackageDocument[]
  aiPopulationHistories  AIPopulationHistory[]

  @@index([projectId])
  @@index([path])
  @@index([processingStatus])
}

model TenderPackageDocument {
  id               String   @id @default(cuid())
  tenderPackageId  String
  documentId       String
  document         Document @relation(fields: [documentId], references: [id])
  includeInSchedule Boolean @default(true)
  order            Int
  createdAt        DateTime @default(now())
  createdBy        String

  @@unique([tenderPackageId, documentId])
  @@index([tenderPackageId])
}

model TenderPackageSection {
  id              String   @id @default(cuid())
  tenderPackageId String
  sectionId       String
  section         Section  @relation(fields: [sectionId], references: [id])
  cardType        String   // 'PLAN', 'CONSULTANT', 'CONTRACTOR'
  discipline      String?  // For consultant/contractor cards (e.g., 'architect', 'electrical')
  createdAt       DateTime @default(now())
  createdBy       String

  @@unique([tenderPackageId, sectionId])
  @@index([tenderPackageId])
  @@index([cardType])
}

model DocumentQueue {
  id         String   @id @default(cuid())
  documentId String   @unique
  status     String   // pending, processing, completed, failed
  retryCount Int      @default(0)
  error      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([status])
}

model AIPopulationHistory {
  id              String   @id @default(cuid())
  documentId      String
  document        Document @relation(fields: [documentId], references: [id])
  cardId          String
  section         String
  populatedFields Json
  createdAt       DateTime @default(now())
  createdBy       String

  @@index([documentId])
  @@index([cardId])
}

model Firm {
  id               String     @id @default(cuid())
  projectId        String
  consultantCardId String?
  contractorCardId String?
  entity           String
  abn              String?
  address          String?
  contact          String?
  email            String?
  mobile           String?
  shortListed      Boolean    @default(false)
  displayOrder     Int
  rfis             Rfi[]
  addendums        Addendum[]
  firmPrices       FirmPrice[]
  createdAt        DateTime   @default(now())
  createdBy        String
  updatedAt        DateTime   @updatedAt
  updatedBy        String
  deletedAt        DateTime?

  @@index([projectId])
  @@index([consultantCardId])
  @@index([contractorCardId])
  @@index([displayOrder])
}

model DisciplineData {
  id            String    @id @default(cuid())
  projectId     String
  disciplineId  String    // e.g., 'architect', 'structural', 'mep'
  scope         String?   @db.Text
  deliverables  String?   @db.Text
  createdAt     DateTime  @default(now())
  createdBy     String
  updatedAt     DateTime  @updatedAt
  updatedBy     String
  deletedAt     DateTime?

  @@unique([projectId, disciplineId])
  @@index([projectId])
  @@index([disciplineId])
}

model Rfi {
  id           String    @id @default(cuid())
  firmId       String
  firm         Firm      @relation(fields: [firmId], references: [id], onDelete: Cascade)
  title        String
  dateReceived DateTime?
  isReceived   Boolean   @default(false)
  documentPath String?
  displayOrder Int
  createdAt    DateTime  @default(now())
  createdBy    String
  updatedAt    DateTime  @updatedAt
  updatedBy    String
  deletedAt    DateTime?

  @@index([firmId])
  @@index([displayOrder])
}

model Addendum {
  id           String    @id @default(cuid())
  firmId       String
  firm         Firm      @relation(fields: [firmId], references: [id], onDelete: Cascade)
  title        String
  dateReleased DateTime?
  isReleased   Boolean   @default(false)
  documentPath String?
  displayOrder Int
  createdAt    DateTime  @default(now())
  createdBy    String
  updatedAt    DateTime  @updatedAt
  updatedBy    String
  deletedAt    DateTime?

  @@index([firmId])
  @@index([displayOrder])
}

model TenderPackageConfig {
  id                    String   @id @default(cuid())
  consultantCardId      String?  @unique
  contractorCardId      String?  @unique
  selectedPlanSections  Json     // Array of Plan Card section IDs
  selectedCardSections  Json     // Array of Consultant/Contractor Card section IDs
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String
  updatedBy             String
  tenderPackages        TenderPackage[]

  @@index([consultantCardId])
  @@index([contractorCardId])
}

model TenderPackage {
  id                    String   @id @default(cuid())
  consultantCardId      String?
  contractorCardId      String?
  firmId                String
  configId              String
  config                TenderPackageConfig @relation(fields: [configId], references: [id])
  generatedContent      Json     // Structured sections
  documentSchedule      Json     // Array of DocumentSchedule
  status                String   @default("draft") // draft, locked
  generatedAt           DateTime @default(now())
  generatedBy           String   // User ID
  aiModel               String   // e.g., "gpt-4-turbo"
  generationTimeMs      Int      // Performance tracking
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([consultantCardId])
  @@index([contractorCardId])
  @@index([firmId])
  @@index([configId])
  @@index([status])
}

// Tender Evaluation Models (Story 4.5)
model TenderEvaluation {
  id               String   @id @default(cuid())
  consultantCardId String?  // FK to ConsultantCard (via Card table)
  contractorCardId String?  // FK to ContractorCard (via Card table)
  projectId        String
  disciplineId     String   // e.g., 'architect', 'structural'
  tables           TenderEvaluationTable[]
  grandTotal       Decimal  @db.Decimal(12, 2) @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdBy        String
  updatedBy        String

  @@unique([consultantCardId, projectId, disciplineId])
  @@unique([contractorCardId, projectId, disciplineId])
  @@index([projectId])
  @@index([disciplineId])
}

model TenderEvaluationTable {
  id               String   @id @default(cuid())
  evaluationId     String
  evaluation       TenderEvaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  tableNumber      Int      // 1 for Original, 2 for Adds/Subs, etc.
  tableName        String   // "Original", "Adds and Subs"
  items            EvaluationLineItem[]
  subTotal         Decimal  @db.Decimal(12, 2) @default(0)
  sortOrder        Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([evaluationId, tableNumber])
}

model EvaluationLineItem {
  id                String   @id @default(cuid())
  tableId           String
  table             TenderEvaluationTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  description       String
  firmPrices        FirmPrice[]  // One price per firm
  isCategory        Boolean  @default(false)  // True for category headers
  parentCategoryId  String?  // Self-referential for hierarchy
  categorySubTotal  Decimal? @db.Decimal(12, 2) // For category rows
  sortOrder         Int
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([tableId, sortOrder])
}

model FirmPrice {
  id              String   @id @default(cuid())
  lineItemId      String
  lineItem        EvaluationLineItem @relation(fields: [lineItemId], references: [id], onDelete: Cascade)
  firmId          String   // FK to Firm
  firm            Firm     @relation(fields: [firmId], references: [id])
  amount          Decimal  @db.Decimal(12, 2) @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([lineItemId, firmId])
  @@index([firmId])
}
